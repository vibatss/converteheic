  <div id="redimensionar-area" style="display:none; margin-top: 30px;">
    <h2 style="color: #4CAF50;">Redimensionar imagem</h2>
    <p>Defina as dimens√µes desejadas antes de baixar:</p>

    <label for="largura">Largura (px):</label>
    <input type="number" id="largura" placeholder="Ex: 800" min="1">
    <br><br>
    <label for="altura">Altura (px):</label>
    <input type="number" id="altura" placeholder="Ex: 600" min="1">
    <br><br>
    <button class="btn" onclick="redimensionarImagem()">Redimensionar e Baixar</button>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    const uploadInput = document.getElementById("upload");
    const preview = document.getElementById("preview");
    const convertBtn = document.getElementById("convertBtn");
    const carregando = document.getElementById("carregando");
    const redimensionarArea = document.getElementById("redimensionar-area");
    let arquivosSelecionados = [];

    uploadInput.addEventListener("change", () => {
      arquivosSelecionados = Array.from(uploadInput.files).slice(0, 5);
      preview.innerHTML = "";
      redimensionarArea.style.display = "none";
      if (arquivosSelecionados.length === 0) {
        convertBtn.style.display = "none";
        return;
      }

      arquivosSelecionados.forEach((file, index) => {
        const fileDiv = document.createElement("div");
        fileDiv.className = "file-entry";

        const nameSpan = document.createElement("span");
        nameSpan.textContent = file.name;

        const deleteBtn = document.createElement("button");
        deleteBtn.innerHTML = "üóë";
        deleteBtn.onclick = () => {
          arquivosSelecionados.splice(index, 1);
          uploadInput.value = "";
          const dataTransfer = new DataTransfer();
          arquivosSelecionados.forEach(f => dataTransfer.items.add(f));
          uploadInput.files = dataTransfer.files;
          uploadInput.dispatchEvent(new Event("change"));
        };

        fileDiv.appendChild(nameSpan);
        fileDiv.appendChild(deleteBtn);
        preview.appendChild(fileDiv);
      });

      convertBtn.style.display = "inline-block";
    });

    async function converter() {
      const formatoSelecionado = document.getElementById("formato").value;
      carregando.style.display = "block";
      preview.innerHTML = "";
      redimensionarArea.style.display = "none";

      for (let file of arquivosSelecionados) {
        try {
          const result = await heic2any({
            blob: file,
            toType: formatoSelecionado,
            quality: 0.9
          });

          const extensao = formatoSelecionado.split("/")[1];
          const url = URL.createObjectURL(result);
          const link = document.createElement("a");
          link.href = url;
          link.download = file.name.replace(/\.heic$/i, `.${extensao}`);
          link.textContent = `‚¨áÔ∏è Baixar ${link.download}`;
          link.className = "btn";
          link.style.display = "block";
          link.style.margin = "10px auto";

          const img = document.createElement("img");
          img.src = url;
          img.style.maxWidth = "100%";
          img.style.marginBottom = "10px";
          preview.appendChild(img);
          preview.appendChild(link);

          redimensionarArea.style.display = "block";

        } catch (e) {
          const error = document.createElement("p");
          error.textContent = `Erro ao converter ${file.name}`;
          preview.appendChild(error);
        }
      }

      carregando.style.display = "none";
    }

    function redimensionarImagem() {
      const largura = parseInt(document.getElementById("largura").value);
      const altura = parseInt(document.getElementById("altura").value);

      if (!largura || !altura) {
        alert("Preencha largura e altura v√°lidas.");
        return;
      }

      const img = document.querySelector("#preview img");
      if (!img) {
        alert("Nenhuma imagem para redimensionar.");
        return;
      }

      const canvas = document.getElementById("canvas");
      canvas.width = largura;
      canvas.height = altura;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, largura, altura);

      canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "imagem-redimensionada.jpg";
        link.click();
      }, "image/jpeg", 0.9);
    }
  </script>
